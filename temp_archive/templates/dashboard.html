<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incubator Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.css">
</head>
<body>
    <div class="container">
        <h1 class="mt-4">Incubator Dashboard</h1>
        <p class="lead">The dashboard gives an overview of activity of incubating projects on incubator.wikimedia.org.</p>
        <form method="POST" id="dashboard-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="slider">Range</label>
                        <div id="slider" class="mt-3"></div>
                        <input type="hidden" id="slider_min" name="slider_min" value="{{ slider_values[0] }}">
                        <input type="hidden" id="slider_max" name="slider_max" value="{{ slider_values[1] }}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="param">Parameter</label>
                        <select id="param" name="param" class="form-control">
                            {% for param in params %}
                                <option value="{{ param }}" {% if param == selected_param %}selected{% endif %}>{{ param }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="project-dropdown">Project</label>
                <select id="project-dropdown" class="form-control">
                    <option value="">Select Project</option>
                    {% for wiki in wikis %}
                        <option value="{{ wiki }}">{{ wiki }}</option>
                    {% endfor %}
                </select>
                <div id="tags-container" class="mt-2"></div>
                <input type="hidden" id="hidden-tags-input" name="hidden_tags" value="{{ selected_wikis | join(',') }}">
            </div>
        </form>
        <div class="mt-3">
            {{ graph_html|safe }}
        </div>
        <p class="mt-4">The dashboard is updated weekly and was last updated on {{ latest_update }}</p>
        <a href="https://github.com/kcvelaga/IncubatorDashboard" class="btn btn-secondary">Source Code</a>
    </div>
    <br>
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.js"></script>

<script>
    const form = document.getElementById('dashboard-form');

    const slider = document.getElementById('slider');
    const sliderMinInput = document.getElementById('slider_min');
    const sliderMaxInput = document.getElementById('slider_max');
    const paramSelect = document.getElementById('param');

    // Initialize noUiSlider
    noUiSlider.create(slider, {
        start: [sliderMinInput.value, sliderMaxInput.value],
        connect: true,
        range: {
            'min': Number(sliderMinInput.value),
            'max': Number(sliderMaxInput.value)
        },
        step: 1,
        tooltips: true,
        format: {
            to: function(value) {
                return Math.round(value);
            },
            from: function(value) {
                return Number(value);
            }
        }
    });

    // Update hidden inputs on slider change
    slider.noUiSlider.on('update', function(values, handle) {
        sliderMinInput.value = values[0];
        sliderMaxInput.value = values[1];
    });

    // Update slider range based on selected parameter
    paramSelect.addEventListener('change', () => {
        updateSliderRange(paramSelect.value);
    });

    // Function to get the range for the selected parameter (dynamic range fetching)
    function getRangeForParameter(param) {
        const paramMin = Number('{{ slider_min }}'); // Use the min value passed from Flask
        const paramMax = Number('{{ slider_max }}'); // Use the max value passed from Flask
        return { min: paramMin, max: paramMax };
    }

    function updateSliderRange(param) {
        const range = getRangeForParameter(param);
        slider.noUiSlider.updateOptions({
            range: {
                'min': range.min,
                'max': range.max
            }
        });

        // Reset slider to new range values
        slider.noUiSlider.set([range.min, range.max]);
    }

    // Initial range update based on the preselected parameter
    document.addEventListener('DOMContentLoaded', function() {
        const initialParam = paramSelect.value;
        const initialRange = getRangeForParameter(initialParam);

        // Set initial slider range
        slider.noUiSlider.updateOptions({
            range: {
                'min': initialRange.min,
                'max': initialRange.max
            }
        });
        slider.noUiSlider.set([initialRange.min, initialRange.max]);

        populateTagsContainer();
    });

    const projectDropdown = document.getElementById('project-dropdown');
    const tagsContainer = document.getElementById('tags-container');
    const hiddenInput = document.getElementById('hidden-tags-input');

    projectDropdown.addEventListener('change', () => {
        const selectedTag = projectDropdown.value;
        if (selectedTag && !tagsContainer.querySelector(`[data-tag="${selectedTag}"]`)) {
            addTag(selectedTag);
        }
        projectDropdown.value = '';
        form.submit();
    });

    tagsContainer.addEventListener('click', event => {
        if (event.target.classList.contains('tag-close')) {
            const tagToRemove = event.target.getAttribute('data-tag');
            const tagElement = event.target.parentElement;
            tagsContainer.removeChild(tagElement);
            populateHiddenInput();
            form.submit();
        }
    });

    function addTag(tagText) {
        const tagElement = document.createElement('div');
        tagElement.className = 'tag';
        tagElement.setAttribute('data-tag', tagText);
        tagElement.innerHTML = `
            <span class="tag-text">${tagText}</span>
            <span class="tag-close" data-tag="${tagText}">x</span>
        `;
        tagsContainer.appendChild(tagElement);
        populateHiddenInput();
    }

    function populateHiddenInput() {
        const tags = [];
        tagsContainer.querySelectorAll('.tag-text').forEach(tag => {
            tags.push(tag.textContent.trim());
        });
        hiddenInput.value = tags.join(',');
    }

    function populateTagsContainer() {
        const selectedTags = hiddenInput.value.split(',');
        selectedTags.forEach(tag => {
            if (tag.trim() !== '') {
                addTag(tag.trim());
            }
        });
    }
</script>
